{{- if $.Values.global.istio.enabled }}
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: {{ template "cluster-providers.fullname" $ }}
spec:
  hosts: 
  - {{ template "cluster-providers.fqdn" $ }}
  http:
{{- range $key,$value := .Values.global.istio.extraDeployments -}}
  {{- range $host, $apps := $value -}}
    {{- range $name, $a := $apps -}}
      {{- if (eq $name "cluster-providers") }}
  - match:
    - headers:
        x-codefresh-version:
          exact: {{ $host }}
    route:                                                                                                                                                                                    
      - destination:                                                                                                                                                                            
          host: {{ template "cluster-providers.fqdn" $ }}
          port:
            number: {{ $.Values.port }}
          subset: {{ $host | replace "." "-" -}}
      {{ end -}}
    {{ end -}}
  {{ end -}}
{{ end }}
  - route:
    - destination:
        host: {{ template "cluster-providers.fqdn" $ }}
        port:
          number: {{ $.Values.port }}
        subset: base
{{ end }}
